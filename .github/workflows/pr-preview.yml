name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  pull_request_target:
    types: [closed]

# Cancel any in-progress preview builds for the same PR when a new commit is pushed
concurrency:
  group: pr-preview-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  build-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Clone awesome-selfhosted-data
        run: git clone https://github.com/awesome-selfhosted/awesome-selfhosted-data.git

      - name: Install Python dependencies
        run: pip install .

      - name: Pylint score (main)
        id: pylint_main
        run: |
          pip install pylint -q
          git fetch origin main
          git checkout origin/main --
          pip install . -q
          SCORE=$(pylint --disable=too-many-locals,line-too-long aswg --exit-zero 2>&1 | sed -n 's/^Your code has been rated at \([-0-9.]*\)\/.*/\1/p' | head -1)
          echo "score=${SCORE:-0}" >> "$GITHUB_OUTPUT"

      - name: Pylint score (PR)
        id: pylint_pr
        run: |
          git checkout ${{ github.event.pull_request.head.sha }} --
          pip install . -q
          PR_SCORE=$(pylint --disable=too-many-locals,line-too-long aswg --exit-zero 2>&1 | sed -n 's/^Your code has been rated at \([-0-9.]*\)\/.*/\1/p' | head -1)
          PR_SCORE=${PR_SCORE:-0}
          MAIN_SCORE=${{ steps.pylint_main.outputs.score }}
          [ -z "$MAIN_SCORE" ] && MAIN_SCORE=0
          DELTA=$(awk "BEGIN { d=$PR_SCORE-$MAIN_SCORE; if(d>0) printf \"+%.1f\", d; else printf \"%.1f\", d }")
          echo "score=${PR_SCORE}" >> "$GITHUB_OUTPUT"
          echo "delta=${DELTA}" >> "$GITHUB_OUTPUT"

      - name: Record build start time
        id: build_timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Generate website
        run: |
          cp ./config/config-pr-preview.yml ./config/config-pr-preview-temp.yml
          sed -i 's|base_path: ""|base_path: "/aswg/pr-${{ github.event.number }}"|g' ./config/config-pr-preview-temp.yml
          aswg --config ./config/config-pr-preview-temp.yml build
          rm -f ./config/config-pr-preview-temp.yml

      - name: Collect build statistics
        if: success()
        id: build_stats
        run: |
          OUTPUT_DIR="output"
          BUILD_END=$(date +%s)
          BUILD_START=${{ steps.build_timer.outputs.start }}
          DURATION_SECS=$((BUILD_END - BUILD_START))
          DURATION_MIN=$((DURATION_SECS / 60))
          DURATION_REM=$((DURATION_SECS % 60))
          [ "$DURATION_MIN" -gt 0 ] && DURATION_STR="${DURATION_MIN}m ${DURATION_REM}s" || DURATION_STR="${DURATION_SECS}s"
          echo "duration=${DURATION_STR}" >> "$GITHUB_OUTPUT"
          echo "total_files=$(find "$OUTPUT_DIR" -type f | wc -l | tr -d ' ')" >> "$GITHUB_OUTPUT"
          echo "html_files=$(find "$OUTPUT_DIR" -name '*.html' -type f | wc -l | tr -d ' ')" >> "$GITHUB_OUTPUT"
          echo "total_size=$(du -sh "$OUTPUT_DIR" | cut -f1)" >> "$GITHUB_OUTPUT"

      # Deploy only if everything above succeeded
      - name: Deploy to GitHub Pages branch
        if: success()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Store current working directory
          WORK_DIR=$(pwd)

          # Check if gh-pages branch exists remotely
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            git fetch origin gh-pages:gh-pages
            git checkout gh-pages
          else
            # Branch doesn't exist, create orphan branch
            git checkout --orphan gh-pages 
            git rm -rf . 
            echo "# PR Previews" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch for PR previews"
            git push origin gh-pages
          fi

          # Create PR directory and copy files
          mkdir -p pr-${{ github.event.number }} 
          cp -r ${WORK_DIR}/output/* pr-${{ github.event.number }}/ 

          [ ! -f active-prs.json ] && echo "[]" > active-prs.json

          # Add/refresh this PR entry with rich metadata
          python3 << 'PYTHON_SCRIPT'
          import json, os
          pr_number = int(os.environ.get('PR_NUMBER', '0'))
          pr_title = os.environ.get('PR_TITLE', f'PR #{pr_number}')
          pr_author = os.environ.get('PR_AUTHOR', 'unknown')
          pr_branch = os.environ.get('PR_BRANCH', '')
          pr_commit = os.environ.get('PR_COMMIT', '')
          repo_url = os.environ.get('REPO_URL', '')

          try:
              with open('active-prs.json', 'r') as f:
                  active_prs = json.load(f)
          except Exception:
              active_prs = []

          # Remove existing entry for this PR
          active_prs = [pr for pr in active_prs if pr.get('number') != pr_number]

          # Add updated entry with full metadata
          active_prs.append({
              'number': pr_number,
              'title': pr_title,
              'author': pr_author,
              'branch': pr_branch,
              'commit': pr_commit[:7] if len(pr_commit) > 7 else pr_commit,
              'commit_full': pr_commit,
              'url': f'pr-{pr_number}/',
              'pr_url': f'{repo_url}/pull/{pr_number}',
              'updated': os.popen('date -Iseconds').read().strip(),
              'build': {
                  'duration': os.environ.get('BUILD_DURATION', 'N/A'),
                  'total_files': os.environ.get('BUILD_FILES', 'N/A'),
                  'html_pages': os.environ.get('BUILD_HTML', 'N/A'),
                  'size': os.environ.get('BUILD_SIZE', 'N/A'),
              }
          })

          active_prs.sort(key=lambda x: x['number'], reverse=True)
          with open('active-prs.json', 'w') as f:
              json.dump(active_prs, f, indent=2)
          PYTHON_SCRIPT
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_COMMIT: ${{ github.event.pull_request.head.sha }}
          BUILD_SIZE: ${{ steps.build_stats.outputs.total_size }}
          BUILD_FILES: ${{ steps.build_stats.outputs.total_files }}
          BUILD_HTML: ${{ steps.build_stats.outputs.html_files }}
          BUILD_DURATION: ${{ steps.build_stats.outputs.duration }}
          REPO_URL: https://github.com/${{ github.repository }}

      - name: Commit & push preview
        if: success()
        run: |
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>PR Previews - ASWG</title>
          <style>
          :root { color-scheme: light dark; }
          body { font-family: system-ui, sans-serif; max-width: 720px; margin: 0 auto; padding: 2rem 1rem; }
          a { color: LinkText; }
          h1 { font-size: 1.4rem; margin: 0; }
          header { margin-bottom: 1.5rem; border-bottom: 1px solid GrayText; padding-bottom: 1rem; }
          header p { margin: .25rem 0 0; color: GrayText; font-size: .9rem; }
          #filter { width: 100%; padding: .5rem; margin-bottom: 1rem; font: inherit; border: 1px solid GrayText; border-radius: 4px; display: none; }
          #status { text-align: right; font-size: .75rem; color: GrayText; margin-bottom: .5rem; }
          table { width: 100%; border-collapse: collapse; }
          th, td { text-align: left; padding: .5rem .75rem; border-bottom: 1px solid light-dark(#e5e7eb, #374151); }
          th { font-size: .75rem; text-transform: uppercase; letter-spacing: .04em; color: GrayText; }
          tr.pr-row:hover { background: light-dark(#f9fafb, #1f2937); }
          .title a { font-weight: 600; }
          .meta { font-size: .8rem; color: GrayText; }
          .meta code { font-size: .78rem; padding: 1px 4px; background: light-dark(#f1f5f9, #334155); border-radius: 3px; }
          .stats { font-variant-numeric: tabular-nums; font-size: .85rem; }
          .actions a { margin-right: .5rem; font-size: .85rem; }
          .empty { text-align: center; padding: 3rem 1rem; color: GrayText; }
          footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid GrayText; font-size: .75rem; color: GrayText; text-align: center; }
          </style>
          </head>
          <body>
          <header>
            <h1>PR Preview Dashboard</h1>
            <p><a href="https://github.com/rabenherz112/aswg">rabenherz112/aswg</a></p>
          </header>
          <input type="text" id="filter" placeholder="Filter by PR number, title, author, or branch...">
          <div id="status">Loading...</div>
          <div id="content"></div>
          <footer>Previews are automatically deployed on PR open and cleaned up on close.</footer>
          <script>
          function timeAgo(d){if(!d)return'';var s=(Date.now()-new Date(d).getTime())/1e3;if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
          function esc(s){var e=document.createElement('span');e.textContent=s||'';return e.innerHTML;}
          var repoBase='https://github.com/rabenherz112/aswg';

          function render(prs){
            var c=document.getElementById('content');
            var f=document.getElementById('filter');
            if(!prs||!prs.length){ f.style.display='none'; c.innerHTML='<div class="empty">No active PR previews. Open a pull request to generate one.</div>'; return; }
            f.style.display=prs.length>=2?'':'none';
            var h='<table><thead><tr><th>Pull Request</th><th>Build</th><th>Links</th></tr></thead><tbody>';
            prs.forEach(function(pr){
              var b=pr.build||{};
              var ago=timeAgo(pr.updated);
              var commitUrl=pr.commit_full?repoBase+'/commit/'+esc(pr.commit_full):'#';
              var stats=[];
              if(b.duration&&b.duration!=='N/A') stats.push(esc(b.duration));
              if(b.size&&b.size!=='N/A') stats.push(esc(b.size));
              if(b.html_pages&&b.html_pages!=='N/A') stats.push(esc(b.html_pages)+' HTML');
              if(b.total_files&&b.total_files!=='N/A') stats.push(esc(b.total_files)+' files');
              h+='<tr class="pr-row" data-q="'+esc(pr.number+' '+pr.title+' '+pr.author+' '+pr.branch).toLowerCase()+'">';
              h+='<td class="title"><a href="'+esc(pr.url)+'">#'+esc(String(pr.number))+' '+esc(pr.title)+'</a>';
              h+='<div class="meta">'+esc(pr.author||'')+' &middot; <code>'+esc(pr.branch||'')+'</code>';
              if(pr.commit) h+=' &middot; <a href="'+commitUrl+'"><code>'+esc(pr.commit)+'</code></a>';
              if(ago) h+=' &middot; '+ago;
              h+='</div></td>';
              h+='<td class="stats">'+stats.join(' / ')+'</td>';
              h+='<td class="actions"><a href="'+esc(pr.url)+'">Preview</a>';
              if(pr.pr_url) h+=' <a href="'+esc(pr.pr_url)+'">PR</a>';
              h+='</td></tr>';
            });
            h+='</tbody></table>'; c.innerHTML=h;
          }
          function load(){
            return fetch('./active-prs.json?_='+Date.now()).then(function(r){if(!r.ok)throw r;return r.json();}).then(function(d){render(d);return d;}).catch(function(){render([]);});
          }
          load().then(function(){ document.getElementById('status').textContent=prs_length_label(); });
          setInterval(function(){ load().then(function(){ document.getElementById('status').textContent=prs_length_label()+' -- refreshed '+new Date().toLocaleTimeString(); }); },60000);
          function prs_length_label(){ var rows=document.querySelectorAll('.pr-row'); return rows.length+' active preview'+(rows.length!==1?'s':''); }
          document.getElementById('filter').addEventListener('input',function(){
            var q=this.value.toLowerCase().trim();
            document.querySelectorAll('.pr-row').forEach(function(row){ row.style.display=(!q||row.getAttribute('data-q').indexOf(q)!==-1)?'':'none'; });
          });
          </script>
          </body>
          </html>
          HTMLEOF

          git add pr-${{ github.event.number }}/ index.html active-prs.json
          [ -f README.md ] && git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "Deploy PR #${{ github.event.number }} preview"
            git push origin gh-pages
          fi

      - name: Mark success
        if: success()
        run: echo "ok" > .build_succeeded

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.payload.pull_request.head.sha;
            const headShaShort = headSha.substring(0, 7);
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const compareUrl = `https://github.com/${owner}/${repo}/pull/${prNumber}/files`;
            const isSuccess = (function(){ try { return fs.existsSync('.build_succeeded'); } catch(e){ return false; } })();
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber });
            const PREVIEW_ANCHOR = '## PR Preview';
            let existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(PREVIEW_ANCHOR));
            let existingPreviewUrl;
            const urlMatch = existing && existing.body.match(/\*\*Preview URL\*\*\s*\|\s*(\S+)/);
            if (urlMatch) existingPreviewUrl = urlMatch[1];
            const computedPreviewUrl = `https://${owner}.github.io/${repo}/pr-${prNumber}/`;
            const effectivePreviewUrl = isSuccess ? computedPreviewUrl : existingPreviewUrl;
            const duration = process.env.BUILD_DURATION || 'N/A';
            const totalSize = process.env.BUILD_TOTAL_SIZE || 'N/A';
            const totalFiles = process.env.BUILD_TOTAL_FILES || 'N/A';
            const htmlPages = process.env.BUILD_HTML_PAGES || 'N/A';
            const pylintScore = process.env.PYLINT_SCORE || 'N/A';
            const pylintDelta = process.env.PYLINT_DELTA || '';

            let body = '## PR Preview\n\n';
            if (isSuccess) {
              body += '| | |\n|---|---|\n';
              body += `| **Preview URL** | ${effectivePreviewUrl} |\n`;
              body += `| **Commit** | [\`${headShaShort}\`](https://github.com/${owner}/${repo}/commit/${headSha}) |\n`;
              body += `| **Build** | ${duration} | ${totalSize} | ${totalFiles} files | ${htmlPages} HTML |\n`;
              body += `| **PyLint Score** | ${pylintScore}${pylintDelta ? ` (${pylintDelta} from main)` : ''} |\n\n`;
              body += `---\n[View workflow run](${runUrl}) | [View PR diff](${compareUrl})\n\n*Comment updates on each push. Preview removed when PR is closed.*`;
            } else {
              body += '### Build Failed\n\n';
              body += '| | |\n|---|---|\n';
              if (effectivePreviewUrl) body += `| **Last Working Preview** | ${effectivePreviewUrl} |\n`;
              body += `| **Commit** | [\`${headShaShort}\`](https://github.com/${owner}/${repo}/commit/${headSha}) |\n`;
              if (pylintScore !== 'N/A') body += `| **PyLint Score** | ${pylintScore}${pylintDelta ? ` (${pylintDelta} from main)` : ''} |\n`;
              body += '\nBuild failed. See [workflow run](' + runUrl + ') for details.\n\n---\n[View PR diff](' + compareUrl + ')';
            }
            if (existing) await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            else await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
        env:
          BUILD_DURATION: ${{ steps.build_stats.outputs.duration }}
          BUILD_TOTAL_SIZE: ${{ steps.build_stats.outputs.total_size }}
          BUILD_TOTAL_FILES: ${{ steps.build_stats.outputs.total_files }}
          BUILD_HTML_PAGES: ${{ steps.build_stats.outputs.html_files }}
          PYLINT_SCORE: ${{ steps.pylint_pr.outputs.score }}
          PYLINT_DELTA: ${{ steps.pylint_pr.outputs.delta }}

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove PR preview directory
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages branch does not exist"
            exit 0
          fi
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
          if [ ! -d "pr-${{ github.event.number }}" ]; then
            echo "PR directory not found"
            exit 0
          fi
          rm -rf pr-${{ github.event.number }}
          if [ -f active-prs.json ]; then
            python3 << 'PYEOF'
          import json
          pr_number = ${{ github.event.number }}
          try:
              with open('active-prs.json', 'r') as f:
                  active_prs = json.load(f)
          except Exception:
              active_prs = []
          active_prs = [pr for pr in active_prs if pr.get('number') != pr_number]
          with open('active-prs.json', 'w') as f:
              json.dump(active_prs, f, indent=2)
          PYEOF
          fi
          git add pr-${{ github.event.number }} active-prs.json
          if ! git diff --staged --quiet; then
            git commit -m "Remove PR #${{ github.event.number }} preview (PR closed)"
            git push origin gh-pages
          fi

      - name: Update PR comment (closed)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const isMerged = context.payload.pull_request.merged;
            const mergedBy = isMerged ? (context.payload.pull_request.merged_by?.login || 'unknown') : null;
            const headBranch = context.payload.pull_request.head.ref;
            const baseBranch = context.payload.pull_request.base.ref;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber });
            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('## PR Preview'));
            if (!botComment) return;
            let body = `## PR Preview *(${isMerged ? 'Merged' : 'Closed'})*\n\n`;
            body += `| | |\n|---|---|\n`;
            body += `| **Branch** | \`${headBranch}\` -> \`${baseBranch}\` |\n`;
            body += `| **Status** | ${isMerged ? `Merged by @${mergedBy}` : 'Closed without merging'} |\n\n`;
            body += `Preview deployment cleaned up.`;
            if (isMerged) body += ` Changes are part of \`${baseBranch}\`.`;
            body += `\n\n---\n*Preview was at \`pr-${prNumber}/\`*`;
            await github.rest.issues.updateComment({ owner, repo, comment_id: botComment.id, body });
