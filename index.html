<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PR Previews - ASWG</title>
<style>
:root { color-scheme: light dark; }
body { font-family: system-ui, sans-serif; max-width: 720px; margin: 0 auto; padding: 2rem 1rem; }
a { color: LinkText; }
h1 { font-size: 1.4rem; margin: 0; }
header { margin-bottom: 1.5rem; border-bottom: 1px solid GrayText; padding-bottom: 1rem; }
header p { margin: .25rem 0 0; color: GrayText; font-size: .9rem; }
#filter { width: 100%; padding: .5rem; margin-bottom: 1rem; font: inherit; border: 1px solid GrayText; border-radius: 4px; display: none; }
#status { text-align: right; font-size: .75rem; color: GrayText; margin-bottom: .5rem; }
table { width: 100%; border-collapse: collapse; }
th, td { text-align: left; padding: .5rem .75rem; border-bottom: 1px solid light-dark(#e5e7eb, #374151); }
th { font-size: .75rem; text-transform: uppercase; letter-spacing: .04em; color: GrayText; }
tr.pr-row:hover { background: light-dark(#f9fafb, #1f2937); }
.title a { font-weight: 600; }
.meta { font-size: .8rem; color: GrayText; }
.meta code { font-size: .78rem; padding: 1px 4px; background: light-dark(#f1f5f9, #334155); border-radius: 3px; }
.stats { font-variant-numeric: tabular-nums; font-size: .85rem; }
.actions a { margin-right: .5rem; font-size: .85rem; }
.empty { text-align: center; padding: 3rem 1rem; color: GrayText; }
footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid GrayText; font-size: .75rem; color: GrayText; text-align: center; }
</style>
</head>
<body>
<header>
  <h1>PR Preview Dashboard</h1>
  <p><a href="https://github.com/rabenherz112/aswg">rabenherz112/aswg</a></p>
</header>
<input type="text" id="filter" placeholder="Filter by PR number, title, author, or branch...">
<div id="status">Loading...</div>
<div id="content"></div>
<footer>Previews are automatically deployed on PR open and cleaned up on close.</footer>
<script>
function timeAgo(d){if(!d)return'';var s=(Date.now()-new Date(d).getTime())/1e3;if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
function esc(s){var e=document.createElement('span');e.textContent=s||'';return e.innerHTML;}
var repoBase='https://github.com/rabenherz112/aswg';

function render(prs){
  var c=document.getElementById('content');
  var f=document.getElementById('filter');
  if(!prs||!prs.length){
    f.style.display='none';
    c.innerHTML='<div class="empty">No active PR previews. Open a pull request to generate one.</div>';
    return;
  }
  f.style.display=prs.length>=2?'':'none';
  var h='<table><thead><tr><th>Pull Request</th><th>Build</th><th>Links</th></tr></thead><tbody>';
  prs.forEach(function(pr){
    var b=pr.build||{};
    var ago=timeAgo(pr.updated);
    var commitUrl=pr.commit_full?repoBase+'/commit/'+esc(pr.commit_full):'#';
    var stats=[];
    if(b.duration&&b.duration!=='N/A') stats.push(esc(b.duration));
    if(b.size&&b.size!=='N/A') stats.push(esc(b.size));
    if(b.html_pages&&b.html_pages!=='N/A') stats.push(esc(b.html_pages)+' pages');
    if(b.app_pages&&b.app_pages!=='N/A') stats.push(esc(b.app_pages)+' apps');
    if(b.total_files&&b.total_files!=='N/A') stats.push(esc(b.total_files)+' files');

    h+='<tr class="pr-row" data-q="'+esc(pr.number+' '+pr.title+' '+pr.author+' '+pr.branch).toLowerCase()+'">';
    h+='<td class="title"><a href="'+esc(pr.url)+'">#'+esc(String(pr.number))+' '+esc(pr.title)+'</a>';
    h+='<div class="meta">'+esc(pr.author||'')+' &middot; <code>'+esc(pr.branch||'')+'</code>';
    if(pr.commit) h+=' &middot; <a href="'+commitUrl+'"><code>'+esc(pr.commit)+'</code></a>';
    if(ago) h+=' &middot; '+ago;
    h+='</div></td>';
    h+='<td class="stats">'+stats.join(' / ')+'</td>';
    h+='<td class="actions"><a href="'+esc(pr.url)+'">Preview</a>';
    if(pr.pr_url) h+='<a href="'+esc(pr.pr_url)+'">PR</a>';
    h+='</td></tr>';
  });
  h+='</tbody></table>';
  c.innerHTML=h;
}

function load(){
  return fetch('./active-prs.json?_='+Date.now())
    .then(function(r){if(!r.ok)throw r;return r.json();})
    .then(function(d){render(d);return d;})
    .catch(function(){render([]);});
}

load().then(function(){
  document.getElementById('status').textContent=prs_length_label();
});

setInterval(function(){
  load().then(function(){
    document.getElementById('status').textContent=prs_length_label()+' -- refreshed '+new Date().toLocaleTimeString();
  });
},60000);

function prs_length_label(){
  var rows=document.querySelectorAll('.pr-row');
  return rows.length+' active preview'+(rows.length!==1?'s':'');
}

document.getElementById('filter').addEventListener('input',function(){
  var q=this.value.toLowerCase().trim();
  var rows=document.querySelectorAll('.pr-row');
  for(var i=0;i<rows.length;i++){
    rows[i].style.display=(!q||rows[i].getAttribute('data-q').indexOf(q)!==-1)?'':'none';
  }
});
</script>
</body>
</html>
